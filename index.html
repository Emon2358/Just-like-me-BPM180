<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MP3 BPM Adjuster</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        h1 {
            color: #1a73e8;
            margin-bottom: 25px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: left;
        }
        input[type="file"], input[type="number"], input[type="range"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        input[type="file"] {
            cursor: pointer;
            background-color: #f9f9f9;
        }
        button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s, transform 0.1s;
            margin: 5px;
        }
        button:hover {
            background-color: #155ab6;
        }
        button:active {
            transform: scale(0.98);
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .bpm-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .bpm-controls input[type="range"] {
            flex-grow: 1;
        }
        .bpm-controls input[type="number"] {
            width: 80px;
        }
        #bpm-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #1a73e8;
        }
        #status {
            margin-top: 20px;
            color: #555;
            min-height: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>MP3 BPM Adjuster ğŸ§</h1>

    <div class="control-group">
        <label for="file-input">1. MP3ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</label>
        <input type="file" id="file-input" accept=".mp3">
    </div>

    <div class="control-group">
        <label for="original-bpm">2. å…ƒã®BPMã‚’å…¥åŠ›</label>
        <input type="number" id="original-bpm" placeholder="ä¾‹: 128" min="30" max="300">
    </div>

    <div class="control-group">
        <label>3. BPMã‚’èª¿æ•´</label>
        <div class="bpm-controls">
            <input type="range" id="bpm-slider" min="50" max="200" value="128" disabled>
            <input type="number" id="bpm-input" min="50" max="200" value="128" disabled>
        </div>
        <p>ç¾åœ¨ã®BPM: <span id="bpm-display">128</span></p>
    </div>

    <div class="control-group">
        <button id="play-pause-button" disabled>å†ç”Ÿ</button>
        <button id="download-button" disabled>WAVå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>

    <p id="status"></p>
</div>

<script>
    // --- DOMè¦ç´ ã®å–å¾— ---
    const fileInput = document.getElementById('file-input');
    const originalBpmInput = document.getElementById('original-bpm');
    const bpmSlider = document.getElementById('bpm-slider');
    const bpmInput = document.getElementById('bpm-input');
    const bpmDisplay = document.getElementById('bpm-display');
    const playPauseButton = document.getElementById('play-pause-button');
    const downloadButton = document.getElementById('download-button');
    const status = document.getElementById('status');

    // --- Web Audio APIã®åˆæœŸåŒ– ---
    let audioContext;
    let audioBuffer;
    let sourceNode;
    let isPlaying = false;
    let originalBpm = 0;

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    fileInput.addEventListener('change', handleFileSelect);
    originalBpmInput.addEventListener('input', handleBpmInput);
    bpmSlider.addEventListener('input', syncBpmInputs);
    bpmInput.addEventListener('input', syncBpmInputs);
    playPauseButton.addEventListener('click', togglePlayback);
    downloadButton.addEventListener('click', downloadAdjustedAudio);

    // --- æ©Ÿèƒ½ã®æœ‰åŠ¹/ç„¡åŠ¹åŒ– ---
    function updateControlsState() {
        const isReady = audioBuffer && originalBpm > 0;
        bpmSlider.disabled = !isReady;
        bpmInput.disabled = !isReady;
        playPauseButton.disabled = !isReady;
        downloadButton.disabled = !isReady;
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç† ---
    async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        // AudioContextã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«åˆæœŸåŒ–ã™ã‚‹
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸­...';
        playPauseButton.disabled = true;
        downloadButton.disabled = true;

        try {
            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            status.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚';
        } catch (error) {
            status.textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            console.error(error);
            audioBuffer = null;
        }
        updateControlsState();
    }

    // --- å…ƒã®BPMå…¥åŠ›æ™‚ã®å‡¦ç† ---
    function handleBpmInput(event) {
        originalBpm = parseFloat(event.target.value) || 0;
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›æ¬„ã®ç¯„å›²ã‚‚æ›´æ–°
        const baseBpm = originalBpm > 0 ? originalBpm : 128;
        bpmSlider.min = Math.floor(baseBpm * 0.5);
        bpmSlider.max = Math.ceil(baseBpm * 2);
        bpmInput.min = Math.floor(baseBpm * 0.5);
        bpmInput.max = Math.ceil(baseBpm * 2);
        // ç¾åœ¨å€¤ã‚’å…ƒã®BPMã«ãƒªã‚»ãƒƒãƒˆ
        bpmSlider.value = baseBpm;
        bpmInput.value = baseBpm;
        bpmDisplay.textContent = baseBpm;
        updateControlsState();
    }

    // --- BPMã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›æ¬„ã®åŒæœŸãƒ»å†ç”Ÿãƒ¬ãƒ¼ãƒˆæ›´æ–° ---
    function syncBpmInputs(event) {
        const newBpm = event.target.value;
        bpmSlider.value = newBpm;
        bpmInput.value = newBpm;
        bpmDisplay.textContent = newBpm;
        updatePlaybackRate();
    }
    
    function updatePlaybackRate() {
        if (!isPlaying || !sourceNode || !originalBpm) return;
        const newBpm = parseFloat(bpmInput.value);
        sourceNode.playbackRate.value = newBpm / originalBpm;
    }

    // --- å†ç”Ÿ/åœæ­¢ã®åˆ‡ã‚Šæ›¿ãˆ ---
    function togglePlayback() {
        if (isPlaying) {
            stopSound();
        } else {
            playSound();
        }
    }

    function playSound() {
        if (!audioBuffer || !audioContext) return;
        sourceNode = audioContext.createBufferSource();
        sourceNode.buffer = audioBuffer;
        updatePlaybackRate();
        sourceNode.connect(audioContext.destination);
        sourceNode.onended = () => {
            stopSound();
        };
        sourceNode.start(0);
        isPlaying = true;
        playPauseButton.textContent = 'åœæ­¢';
    }

    function stopSound() {
        if (sourceNode) {
            sourceNode.stop();
            sourceNode.disconnect();
            sourceNode = null;
        }
        isPlaying = false;
        playPauseButton.textContent = 'å†ç”Ÿ';
    }

    // --- èª¿æ•´å¾ŒéŸ³æºã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç† ---
    async function downloadAdjustedAudio() {
        if (!audioBuffer || !originalBpm) {
            alert('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ•ã‚¡ã‚¤ãƒ«ã¨å…ƒã®BPMãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return;
        }
        
        status.textContent = 'éŸ³æºã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­...ã“ã‚Œã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™ã€‚';
        downloadButton.disabled = true;

        try {
            const newBpm = parseFloat(bpmInput.value);
            const playbackRate = newBpm / originalBpm;
            
            // OfflineAudioContextã§ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå†ç”Ÿé€Ÿåº¦ã®å¤‰æ›´ï¼‰ã‚’é©ç”¨
            const offlineContext = new OfflineAudioContext(
                audioBuffer.numberOfChannels,
                audioBuffer.length,
                audioBuffer.sampleRate
            );

            const offlineSource = offlineContext.createBufferSource();
            offlineSource.buffer = audioBuffer;
            offlineSource.playbackRate.value = playbackRate;
            offlineSource.connect(offlineContext.destination);
            offlineSource.start(0);

            const renderedBuffer = await offlineContext.startRendering();
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒãƒƒãƒ•ã‚¡ã‚’WAVã«å¤‰æ›
            const wavBlob = bufferToWav(renderedBuffer);

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆã—ã¦ã‚¯ãƒªãƒƒã‚¯
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `adjusted_bpm_${newBpm}.wav`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            status.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
        } catch(e) {
            status.textContent = 'ã‚¨ãƒ©ãƒ¼: éŸ³æºã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            console.error(e);
        } finally {
            downloadButton.disabled = false;
        }
    }

    // --- AudioBufferã‚’WAV Blobã«å¤‰æ›ã™ã‚‹é–¢æ•° ---
    function bufferToWav(buffer) {
        const numOfChan = buffer.numberOfChannels;
        const length = buffer.length * numOfChan * 2 + 44;
        const bufferArr = new ArrayBuffer(length);
        const view = new DataView(bufferArr);
        const channels = [];
        let i, sample;
        let offset = 0;
        let pos = 0;

        // ãƒ˜ãƒƒãƒ€ã‚’æ›¸ãè¾¼ã‚€
        setUint32(0x46464952); // "RIFF"
        setUint32(length - 8); // file length - 8
        setUint32(0x45564157); // "WAVE"
        setUint32(0x20746d66); // "fmt " chunk
        setUint32(16); // length = 16
        setUint16(1); // PCM (uncompressed)
        setUint16(numOfChan);
        setUint32(buffer.sampleRate);
        setUint32(buffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
        setUint16(numOfChan * 2); // block-align
        setUint16(16); // 16-bit
        setUint32(0x61746164); // "data" - chunk
        setUint32(length - pos - 4); // chunk length

        function setUint16(data) {
            view.setUint16(pos, data, true);
            pos += 2;
        }
        function setUint32(data) {
            view.setUint32(pos, data, true);
            pos += 4;
        }

        // PCMãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚€
        for (i = 0; i < numOfChan; i++) {
            channels.push(buffer.getChannelData(i));
        }

        while (pos < length) {
            for (i = 0; i < numOfChan; i++) {
                sample = Math.max(-1, Math.min(1, channels[i][offset]));
                sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0;
                view.setInt16(pos, sample, true);
                pos += 2;
            }
            offset++;
        }

        return new Blob([view], { type: 'audio/wav' });
    }

</script>
</body>
</html>
